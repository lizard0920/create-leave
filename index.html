<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>請假時數計算器</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #45a049;
    }
    .result {
      margin-top: 20px;
      font-size: 1.1em;
      word-break: break-word;
    }
    .label {
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>請假計算</h2>
    <label for="leaveStart">請假起：</label>
    <input type="time" id="leaveStart" step="1800" />

    <label for="leaveEnd">請假迄：</label>
    <input type="time" id="leaveEnd" step="1800" />

    <button onclick="calculateLeave()">計算</button>

    <div class="result">
      <div class="label">請假時數：</div>
      <div id="leaveHour"></div>

      <div class="label">應請假時間：</div>
      <div id="leaveRange"></div>

      <div class="label">應打卡時間：</div>
      <div id="leavePunch"></div>
    </div>
  </div>

  <script>
    // 強制分鐘只允許00或30，四捨五入
    function normalizeTime(timeStr) {
      let [h, m] = timeStr.split(":").map(Number);
      if (m < 15) m = 0;
      else if (m < 45) m = 30;
      else {
        m = 0;
        h = (h + 1) % 24;
      }
      return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    }

    // 轉成小時小數
    function parseTimeToDecimal(timeStr) {
      const [hour, minute] = timeStr.split(":").map(Number);
      return hour + minute / 60;
    }

    // 小時小數轉回HH:MM
    function formatDecimalToHHMM(decimal) {
      const hour = Math.floor(decimal);
      const minute = Math.round((decimal - hour) * 60);
      return `${String(hour).padStart(2,"0")}:${String(minute).padStart(2,"0")}`;
    }

    // 主計算函式
    function calculateLeave() {
      let start = document.getElementById("leaveStart").value;
      let end = document.getElementById("leaveEnd").value;
      const leaveHourEl = document.getElementById("leaveHour");
      const leaveRangeEl = document.getElementById("leaveRange");
      const leavePunchEl = document.getElementById("leavePunch");

      if (!start || !end) {
        leaveHourEl.textContent = "請填寫請假起訖時間";
        leaveRangeEl.textContent = "";
        leavePunchEl.textContent = "";
        return;
      }

      // 正規化時間
      start = normalizeTime(start);
      end = normalizeTime(end);

      const startDec = parseTimeToDecimal(start);
      const endDec = parseTimeToDecimal(end);

      // 計算午休扣除
      let breakDeduct = 0;
      if (startDec < 13 && endDec > 13) {
        breakDeduct = 1;
      } else if (end === "12:30") {
        breakDeduct = 0.5;
      }

      let leaveHours = endDec - startDec - breakDeduct;
      if (leaveHours < 0) leaveHours = 0;

      // 應請假時間顯示
      let leaveRangeText = `${start} - ${end}`;
      if (start === "09:00" && (end === "12:30" || end === "13:00")) {
        leaveRangeText = "09:00 - 12:00";
      }

      // 應打卡時間判斷，參考Excel公式
      function timeToNumber(t) {
        const [h, m] = t.split(":").map(Number);
        return h + m / 60;
      }
      const T9 = timeToNumber("09:00");
      const T12 = timeToNumber("12:00");
      const T1230 = timeToNumber("12:30");
      const T13 = timeToNumber("13:00");
      const T1330 = timeToNumber("13:30");
      const T14 = timeToNumber("14:00");
      const T18 = timeToNumber("18:00");

      let punchText = "";

      if (timeToNumber(start) >= timeToNumber(end)) {
        punchText = "";
      } else if (start !== "09:00" && end !== "18:00") {
        punchText = "09:00 - 18:00";
      } else if (start === "09:00" && end === "18:00") {
        punchText = "";
      } else {
        let morningPunch = "";
        let afternoonPunch = "";

        if (timeToNumber(start) >= T9 && timeToNumber(end) <= T12) {
          morningPunch = end;
        } else if (timeToNumber(start) >= T9 && (end === "12:30" || end === "13:00")) {
          morningPunch = "12:00";
        } else if (timeToNumber(start) >= T9 && end === "13:30") {
          morningPunch = "12:30";
        } else if (timeToNumber(start) >= T9) {
          morningPunch = "09:00";
        } else {
          morningPunch = "X"; // 可自行調整
        }

        if (timeToNumber(start) >= T13 && timeToNumber(start) <= T14) {
          afternoonPunch = formatDecimalToHHMM(timeToNumber(start) - 1);
        } else if (timeToNumber(start) >= T9 && end === "18:00") {
          afternoonPunch = start;
        } else {
          afternoonPunch = "18:00";
        }

        punchText = `${morningPunch} - ${afternoonPunch}`;
      }

      leaveHourEl.textContent = leaveHours.toFixed(2) + " 小時";
      leaveRangeEl.textContent = leaveRangeText;
      leavePunchEl.textContent = punchText;
    }
  </script>
</body>
</html>
